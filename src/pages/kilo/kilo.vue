<template>
  <div class="kilo">
    <!-- {
      "id": 8535752199279,
      "room_num": "123",
      "room_name": null,
      "camera_name": "long",
      "nvr_ip": "192.168.1.101",
      "camera_ip": "192.168.1.10",
      "camera_mac": "::",
      "sn_num": "123456",
      "manufacturer": "HK",
      "activate_pwd": null,
      "camera_type": null,
      "dev_version": "v1.0",
      "channel_type": null,
      "harmony_auth": "v1.2",
      "nvr_url": "/lele",
      "is_harmony": 1,
      "gb_code": "gbCode",
      "gb_pwd": "gb_pwd",
      "station_code": null,
      "station_ip": "192.168.1.2",
      "station_port": 8080,
      "station_auth_type": null,
      "station_heartbeat": null,
      "station_protocol_version": null,
      "station_sip_trans_type": null,
      "station_register_rs_time": null,
      "station_enable": null,
      "harmony_platform_ip": null,
      "harmony_platform_port": 0,
      "harmony_platform_username": null,
      "harmony_platform_pwd": null,
      "state": null,
      "create_time": null,
      "create_by": "",
      "update_by": "",
      "update_time": null,
      "camera_username": null,
      "camera_pwd": "123123"
    } -->
    <el-form :model="form" inline ref="kiloForm">
      <el-form-item label="ÁîµÊàøÁºñÁ†Å" prop="room_num">
        <el-input v-model="form.room_num"></el-input>
      </el-form-item>
      <el-form-item label="ÁîµÊàøÂêçÁß∞" prop="room_name">
        <el-input v-model="form.room_name"></el-input>
      </el-form-item>
      <el-form-item label="ÊëÑÂÉèÂ§¥ÂêçÁß∞" prop="camera_name">
        <el-input v-model="form.camera_name"></el-input>
      </el-form-item>
      <el-form-item label="NVR-IP" prop="nvr_ip">
        <el-input v-model="form.nvr_ip"></el-input>
      </el-form-item>
      <el-form-item label="ÊëÑÂÉèÂ§¥IP" prop="camera_ip">
        <el-input v-model="form.camera_ip"></el-input>
      </el-form-item>
      <el-form-item label="ÊëÑÂÉèÂ§¥MAC" prop="camera_mac">
        <el-input v-model="form.camera_mac"></el-input>
      </el-form-item>
      <el-form-item label="SNÂè∑" prop="sn_num">
        <el-input v-model="form.sn_num"></el-input>
      </el-form-item>
      <el-form-item label="ÂéÇÂïÜ" prop="manufacturer">
        <el-input v-model="form.manufacturer"></el-input>
      </el-form-item>
      <el-form-item label="ÊëÑÂÉèÂ§¥Á±ªÂûã" prop="camera_type">
        <el-input v-model="form.camera_type"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="handleSearch">Êü•ËØ¢</el-button>
      </el-form-item>
      <el-form-item>
        <el-button type="info" @click="handleReset">ÈáçÁΩÆ</el-button>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="handleExport">ÂØºÂá∫</el-button>
      </el-form-item>
    </el-form>
    <!-- ‰∏äÈù¢ÂØπË±°‰∏∫ÂàóË°®Êï∞ÊçÆÔºå‰∏ãÈù¢ÂØπË±°‰∏∫Ë°®ÂçïÊï∞ÊçÆ -->
    <el-table :data="listData" style="width: 100%" border>
      <!-- <el-table-column prop="id" label="ID" width="180" fixed="left" />
      <el-table-column prop="room_num" label="room_num" width="120" />
      <el-table-column prop="room_name" label="room_name" width="120" />
      <el-table-column prop="camera_name" label="camera_name" width="120" />
      <el-table-column prop="nvr_ip" label="nvr_ip" width="110" />
      <el-table-column prop="camera_ip" label="camera_ip" width="110" />
      <el-table-column prop="camera_mac" label="camera_mac" width="140" />
      <el-table-column prop="sn_num" label="sn_num" width="100" />
      <el-table-column prop="manufacturer" label="manufacturer" width="100" />
      <el-table-column prop="activate_pwd" label="activate_pwd" width="100" />
      <el-table-column prop="camera_type" label="camera_type" width="95" />
      <el-table-column prop="dev_version" label="dev_version" width="95" />
      <el-table-column prop="channel_type" label="channel_type" width="100" />
      <el-table-column prop="harmony_auth" label="harmony_auth" width="110" />
      <el-table-column prop="nvr_url" label="nvr_url" width="120" />
      <el-table-column prop="is_harmony" label="is_harmony" width="90" />
      <el-table-column prop="gb_code" label="gb_code" width="130" />
      <el-table-column prop="gb_pwd" label="gb_pwd" width="100" />
      <el-table-column prop="station_code" label="station_code" width="100" />
      <el-table-column prop="station_ip" label="station_ip" width="110" />
      <el-table-column prop="station_port" label="station_port" width="90" />
      <el-table-column prop="station_auth_type" label="station_auth_type" width="130" />
      <el-table-column prop="station_heartbeat" label="station_heartbeat" width="130" />
      <el-table-column prop="station_protocol_version" label="station_protocol_version" width="180" />
      <el-table-column prop="station_sip_trans_type" label="station_sip_trans_type" width="170" />
      <el-table-column prop="station_register_rs_time" label="station_register_rs_time" width="180" />
      <el-table-column prop="station_enable" label="station_enable" width="110" />
      <el-table-column prop="harmony_platform_ip" label="harmony_platform_ip" width="150" />
      <el-table-column prop="harmony_platform_port" label="harmony_platform_port" width="170" />
      <el-table-column prop="harmony_platform_username" label="harmony_platform_username" width="210" />
      <el-table-column prop="harmony_platform_pwd" label="harmony_platform_pwd" width="180" />
      <el-table-column prop="state" label="state" width="80" />
      <el-table-column prop="create_time" label="create_time" width="110" />
      <el-table-column prop="create_by" label="create_by" width="100" />
      <el-table-column prop="update_by" label="update_by" width="100" />
      <el-table-column prop="update_time" label="update_time" width="110" />
      <el-table-column prop="camera_username" label="camera_username" width="130" />
      <el-table-column prop="camera_pwd" label="camera_pwd" width="110" /> -->
      <el-table-column v-for="col in columns" :key="col.key" :prop="col.key" :label="col.title" :width="col.width" :fixed="col.fixed">
        <template #default="{ row, column }">
          <template v-if="currentEditableRow === row.id">
            <el-input v-model="row[column.property]" :disabled="col.editable === false"></el-input>
          </template>
          <template v-else>
            {{ row[column.property] }}
          </template>
        </template>
      </el-table-column>
      <el-table-column label="Êìç‰Ωú" width="180" fixed="right">
        <template #header>
          <el-button type="primary" plain size="small" @click="handleAdd">Ê∑ªÂä†</el-button>
        </template>
        <template #default="{ row }">
          <el-button type="primary" plain size="small" v-if="currentEditableRow !== row.id" @click="handleEdit(row)">ÁºñËæë</el-button>
          <el-button type="info" plain size="small" v-if="currentEditableRow === row.id && actionType" @click="canncelEdit(row)">ÂèñÊ∂à</el-button>
          <el-button type="primary" plain size="small" v-if="currentEditableRow === row.id && actionType" @click="handleSubmit(row)">‰øùÂ≠ò</el-button>
          <el-button type="danger" plain size="small" @click="handleDelete(row)">Âà†Èô§</el-button>
        </template>
      </el-table-column>
    </el-table>
    <!-- ÂàÜÈ°µÁªÑ‰ª∂ -->
    <el-pagination
      @current-change="handlePageChange"
      @size-change="handleSizeChange"
      :current-page="page.current"
      :page-sizes="page.pageSizes"
      :page-size="page.pageSize"
      layout="total, sizes, prev, pager, next"
      :total="page.total"
    >
    </el-pagination>
  </div>
</template>
<script>
import { ref, reactive, onMounted } from 'vue'
import { columns, exportCsv } from './tableColumn'
import request from '@/utils/axios'
import { ElMessage } from 'element-plus'

export default {
  setup() {
    // ÂàÜÈ°µÊï∞ÊçÆ
    const page = reactive({
      current: 1,
      pageSize: 10,
      pageSizes: [5, 10, 20, 50],
      total: 0
    })
    // Êü•ËØ¢Ë°®Âçïform
    const form = reactive({
      room_num: '',
      room_name: '',
      camera_name: '',
      nvr_ip: '',
      camera_ip: '',
      camera_mac: '',
      sn_num: '',
      manufacturer: '',
      camera_type: ''
    })
    // Êü•ËØ¢
    const handleSearch = () => {
      console.log('üöÄ ~ handleSearch ~ form:', form)
      fetchList()
    }
    // ÈáçÁΩÆ
    let kiloForm = ref(null)
    const handleReset = () => {
      kiloForm.value.resetFields()
      fetchList()
    }
    // ÂØºÂá∫
    const handleExport = () => {
      fetchList(1).then(data => {
        exportCsv(
          columns.map(itm => itm.title),
          data,
          /* data.map(itm => {
            return {
              ...itm,
              camera_type: itm.camera_type === 1 ? 'Êû™Êú∫' : 'ÁêÉÊú∫'
            }
          }), */
          'ÊëÑÂÉèÂ§¥ÂàóË°®'
        )
      })
    }

    // ÂàóË°®Êï∞ÊçÆ
    const listData = ref([])
    const actionType = ref('')
    const currentItem = reactive({ id: '' })

    // Ëé∑ÂèñÂàóË°®Êï∞ÊçÆ
    const fetchList = async exports => {
      const response = await request.get(`/kilo/cameras`, {
        params: {
          page: exports ? 1 : page.current,
          pageSize: exports ? 10000 : page.pageSize,
          ...form
        }
      })
      if (response.code === 200) {
        let { total, list } = response.data
        list = list.map(itm => {
          return {
            ...itm,
            update_time: itm.update_time && itm.update_time.slice(0, 19).replace('T', ' '),
            create_time: itm.create_time && itm.create_time.slice(0, 19).replace('T', ' ')
          }
        })
        if (exports) {
          return list
        }
        listData.value = list
        page.total = total
      } else {
        ElMessage.error('Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•')
      }
    }
    const currentEditableRow = ref('')
    // ÁºñËæë
    const handleEdit = row => {
      currentEditableRow.value = row.id // ÂÅáËÆæÊØèË°åÊï∞ÊçÆÊúâ‰∏Ä‰∏™ÂîØ‰∏ÄÁöÑ id
      actionType.value = 'edit'
    }

    // È°µÁ†ÅÊîπÂèò‰∫ã‰ª∂
    const handlePageChange = newPage => {
      page.current = newPage
      fetchList()
    }

    // Ê∑ªÂä†È°π
    const handleAdd = () => {
      actionType.value = 'add'
      currentEditableRow.value = ''
      listData.value.push({ id: '' })
    }
    // Âà†Èô§È°π
    const handleDelete = async item => {
      try {
        let res = await request.delete(`/kilo/camera/${item.id}`)
        if (res.code === 200) {
          ElMessage.success('Âà†Èô§ÊàêÂäü')
          fetchList()
        } else {
          ElMessage.error('Âà†Èô§Â§±Ë¥•:' + res.msg)
        }
      } catch (error) {
        ElMessage.error('Âà†Èô§Â§±Ë¥•')
      }
    }

    // Â§ÑÁêÜÊ∑ªÂä†ÊàñÁºñËæë
    const handleSubmit = async row => {
      try {
        const method = actionType.value === 'edit' ? 'PUT' : 'POST'
        let res = await request({
          url: '/kilo/camera',
          method,
          data: row
        })
        if (res.code === 200) {
          ElMessage.success(actionType.value === 'add' ? 'Ê∑ªÂä†ÊàêÂäü' : 'Êõ¥Êñ∞ÊàêÂäü')
          fetchList()
        } else {
          ElMessage.error('Êìç‰ΩúÂ§±Ë¥•: ' + res.msg)
        }
      } catch (error) {
        ElMessage.error('Êìç‰ΩúÂ§±Ë¥•: ' + error.msg)
      }
      currentEditableRow.value = ''
      actionType.value = ''
    }

    onMounted(() => {
      fetchList()
    })

    return {
      form,
      kiloForm,
      columns,
      handleReset,
      handleSearch,
      handleExport,
      currentEditableRow,
      handleEdit,
      canncelEdit() {
        currentEditableRow.value = ''
        actionType.value = ''
      },
      listData,
      page,
      handlePageChange,
      // ÊØèÈ°µÊï∞ÈáèÊîπÂèò‰∫ã‰ª∂
      handleSizeChange: newPageSize => {
        page.pageSize = newPageSize
        page.current = 1
        fetchList()
      },
      handleAdd,
      handleDelete,
      actionType,
      currentItem,
      handleSubmit
    }
  },
  mounted() {
    window._k = this
  }
}
</script>
<style lang="less" scoped>
.kilo {
  text-align: left;
  :deep(.el-table) {
    .cell {
      padding: 0 2px;
    }
  }
}
</style>
